# ============================================================================
# STF AI Diagnosis Platform - Docker Compose Configuration
# Author: Li-Ta Hsu
# Date: January 2026
# ============================================================================
# Local-first deployment for Phase 1 pilot
# All services bound to 127.0.0.1 for security
# No external LLM API calls - uses local Ollama inference
# ============================================================================

version: '3.8'

# ============================================================================
# NETWORKS - Internal-only communication, localhost exposure
# ============================================================================
networks:
  stf-internal:
    driver: bridge
    internal: false # Allows outbound for initial pulls, runtime egress controlled via SSRF proxy
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================================
# VOLUMES - Named volumes for data persistence
# ============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  weaviate_data:
    driver: local
  ollama_data:
    driver: local
  dify_storage:
    driver: local
  diagnostic_api_logs:
    driver: local

# ============================================================================
# SERVICES
# ============================================================================
services:
  # --------------------------------------------------------------------------
  # Postgres - Primary database for Dify and diagnostic_api
  # --------------------------------------------------------------------------
  postgres:
    image: postgres:${POSTGRES_VERSION:-15.6-alpine}
    container_name: stf-postgres
    restart: unless-stopped
    networks:
      - stf-internal
    ports:
      - "${BIND_HOST:-127.0.0.1}:${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-dify}
      POSTGRES_USER: ${POSTGRES_USER:-dify_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      APP_DB_PASSWORD: ${APP_DB_PASSWORD:?APP_DB_PASSWORD must be set}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dify_user} -d ${POSTGRES_DB:-dify}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: >
      postgres -c max_connections=${POSTGRES_MAX_CONNECTIONS:-100} -c shared_buffers=256MB -c effective_cache_size=1GB -c maintenance_work_mem=64MB -c checkpoint_completion_target=0.9 -c wal_buffers=16MB -c default_statistics_target=100 -c random_page_cost=1.1 -c effective_io_concurrency=200 -c work_mem=2621kB -c min_wal_size=1GB -c max_wal_size=4GB

  # --------------------------------------------------------------------------
  # Redis - Cache and message broker for Dify and diagnostic_api
  # --------------------------------------------------------------------------
  redis:
    image: redis:${REDIS_VERSION:-7.2.4-alpine}
    container_name: stf-redis
    restart: unless-stopped
    networks:
      - stf-internal
    ports:
      - "${BIND_HOST:-127.0.0.1}:${REDIS_PORT:-6379}:6379"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
    volumes:
      - redis_data:/data
    command: >
      redis-server --requirepass ${REDIS_PASSWORD} --maxmemory ${REDIS_MAXMEMORY:-512mb} --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru} --appendonly yes --appendfsync everysec
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s

  # --------------------------------------------------------------------------
  # Weaviate - Vector database for RAG retrieval
  # --------------------------------------------------------------------------
  weaviate:
    image: semitechnologies/weaviate:${WEAVIATE_VERSION:-1.24.1}
    container_name: stf-weaviate
    restart: unless-stopped
    networks:
      - stf-internal
    ports:
      - "${BIND_HOST:-127.0.0.1}:${WEAVIATE_PORT:-8080}:8080"
      - "${BIND_HOST:-127.0.0.1}:${WEAVIATE_GRPC_PORT:-50051}:50051"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: ${WEAVIATE_AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED:-false}
      AUTHENTICATION_APIKEY_ENABLED: ${WEAVIATE_AUTHENTICATION_APIKEY_ENABLED:-true}
      AUTHENTICATION_APIKEY_ALLOWED_KEYS: ${WEAVIATE_AUTHENTICATION_APIKEY_ALLOWED_KEYS:?WEAVIATE_AUTHENTICATION_APIKEY_ALLOWED_KEYS must be set}
      AUTHENTICATION_APIKEY_USERS: ${WEAVIATE_AUTHENTICATION_APIKEY_USERS:-admin}
      PERSISTENCE_DATA_PATH: ${WEAVIATE_PERSISTENCE_DATA_PATH:-/var/lib/weaviate}
      DEFAULT_VECTORIZER_MODULE: ${WEAVIATE_DEFAULT_VECTORIZER_MODULE:-none}
      CLUSTER_HOSTNAME: ${WEAVIATE_CLUSTER_HOSTNAME:-node1}
      ENABLE_MODULES: ''
      LIMIT_RESOURCES: ${WEAVIATE_LIMIT_RESOURCES:-true}
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --------------------------------------------------------------------------
  # Ollama - Local LLM inference runtime
  # --------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:${OLLAMA_VERSION:-0.1.26}
    container_name: stf-ollama
    restart: unless-stopped
    networks:
      - stf-internal
    ports:
      - "${BIND_HOST:-127.0.0.1}:${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
    # Healthcheck removed: curl not available in minimal image
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:11434/api/version"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 60s
    # Uncomment for GPU support on Linux with NVIDIA
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

    # --------------------------------------------------------------------------
    # Dify API - Backend service for Dify workflow orchestration
    # --------------------------------------------------------------------------
  dify-api:
    image: langgenius/dify-api:${DIFY_VERSION:-0.6.13}
    container_name: stf-dify-api
    restart: unless-stopped
    networks:
      - stf-internal
    ports:
      - "${BIND_HOST:-127.0.0.1}:${DIFY_API_PORT:-5001}:5001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      weaviate:
        condition: service_healthy
    environment:
      # Core Dify settings
      MODE: api
      LOG_LEVEL: INFO
      SECRET_KEY: ${DIFY_SECRET_KEY:?DIFY_SECRET_KEY must be set}
      CONSOLE_WEB_URL: http://${BIND_HOST:-127.0.0.1}:${DIFY_WEB_PORT:-3000}
      CONSOLE_API_URL: http://${BIND_HOST:-127.0.0.1}:${DIFY_API_PORT:-5001}
      SERVICE_API_URL: http://${BIND_HOST:-127.0.0.1}:${DIFY_API_PORT:-5001}
      APP_WEB_URL: http://${BIND_HOST:-127.0.0.1}:${DIFY_WEB_PORT:-3000}

      # Database
      DB_USERNAME: ${POSTGRES_USER:-dify_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_HOST: ${POSTGRES_HOST:-postgres}
      DB_PORT: ${POSTGRES_PORT:-5432}
      DB_DATABASE: ${POSTGRES_DB:-dify}

      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_USE_SSL: ${DIFY_REDIS_USE_SSL:-false}
      REDIS_DB: 0
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@${REDIS_HOST:-redis}:${REDIS_PORT:-6379}/1
      BROKER_USE_SSL: ${DIFY_REDIS_USE_SSL:-false}

      # Storage
      STORAGE_TYPE: ${DIFY_STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: ${DIFY_STORAGE_LOCAL_PATH:-/app/storage}

      # Vector Store
      VECTOR_STORE: ${DIFY_VECTOR_STORE:-weaviate}
      WEAVIATE_ENDPOINT: ${DIFY_WEAVIATE_ENDPOINT:-http://weaviate:8080}
      WEAVIATE_API_KEY: ${WEAVIATE_AUTHENTICATION_APIKEY_ALLOWED_KEYS}

      # Edition
      EDITION: ${DIFY_EDITION:-SELF_HOSTED}
      DEPLOY_ENV: ${DIFY_DEPLOY_ENV:-PRODUCTION}

      # Database migration on startup
      MIGRATION_ENABLED: "true"

      # SSRF Protection
      SSRF_PROXY_HTTP_URL: ${DIFY_SSRF_PROXY_HTTP_URL:-}
      SSRF_PROXY_HTTPS_URL: ${DIFY_SSRF_PROXY_HTTPS_URL:-}

      # Sandbox
      CODE_EXECUTION_API_KEY: dify-sandbox
      CODE_EXECUTION_ENDPOINT: http://sandbox:8194
    volumes:
      - dify_storage:/app/storage
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # --------------------------------------------------------------------------
  # Dify Worker - Celery worker for background tasks
  # --------------------------------------------------------------------------
  dify-worker:
    image: langgenius/dify-api:${DIFY_VERSION:-0.6.13}
    container_name: stf-dify-worker
    restart: unless-stopped
    networks:
      - stf-internal
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Core Dify settings
      MODE: worker
      LOG_LEVEL: INFO
      SECRET_KEY: ${DIFY_SECRET_KEY}

      # Database
      DB_USERNAME: ${POSTGRES_USER:-dify_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_HOST: ${POSTGRES_HOST:-postgres}
      DB_PORT: ${POSTGRES_PORT:-5432}
      DB_DATABASE: ${POSTGRES_DB:-dify}

      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_USE_SSL: ${DIFY_REDIS_USE_SSL:-false}
      REDIS_DB: 0
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@${REDIS_HOST:-redis}:${REDIS_PORT:-6379}/1
      BROKER_USE_SSL: ${DIFY_REDIS_USE_SSL:-false}

      # Storage
      STORAGE_TYPE: ${DIFY_STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: ${DIFY_STORAGE_LOCAL_PATH:-/app/storage}

      # Vector Store
      VECTOR_STORE: ${DIFY_VECTOR_STORE:-weaviate}
      WEAVIATE_ENDPOINT: ${DIFY_WEAVIATE_ENDPOINT:-http://weaviate:8080}
      WEAVIATE_API_KEY: ${WEAVIATE_AUTHENTICATION_APIKEY_ALLOWED_KEYS}

      # Sandbox
      CODE_EXECUTION_API_KEY: dify-sandbox
      CODE_EXECUTION_ENDPOINT: http://sandbox:8194

    volumes:
      - dify_storage:/app/storage
    healthcheck:
      test: [ "CMD-SHELL", "celery -A app.celery inspect ping || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # --------------------------------------------------------------------------
  # Dify Sandbox - Secure code execution environment
  # --------------------------------------------------------------------------
  sandbox:
    image: langgenius/dify-sandbox:0.2.1
    container_name: stf-dify-sandbox
    restart: unless-stopped
    networks:
      - stf-internal
    environment:
      API_KEY: dify-sandbox
      GIN_MODE: release
      worker_timeout: 15
      ENABLE_NETWORK: "true"
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
      SANDBOX_PORT: 8194
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8194/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # --------------------------------------------------------------------------
  # Dify Web - Frontend UI
  # --------------------------------------------------------------------------
  dify-web:
    image: langgenius/dify-web:${DIFY_VERSION:-0.6.13}
    container_name: stf-dify-web
    restart: unless-stopped
    networks:
      - stf-internal
    ports:
      - "${BIND_HOST:-127.0.0.1}:${DIFY_WEB_PORT:-3000}:3000"
    depends_on:
      dify-api:
        condition: service_healthy
    environment:
      CONSOLE_API_URL: http://${BIND_HOST:-127.0.0.1}:${DIFY_API_PORT:-5001}
      APP_API_URL: http://dify-api:5001
      EDITION: ${DIFY_EDITION:-SELF_HOSTED}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # --------------------------------------------------------------------------
  # Diagnostic API - FastAPI backend (stub for Phase 1)
  # --------------------------------------------------------------------------
  diagnostic-api:
    build:
      context: ..
      dockerfile: diagnostic_api/Dockerfile
    image: stf-diagnostic-api:${DIAGNOSTIC_API_VERSION:-0.1.0}
    container_name: stf-diagnostic-api
    restart: unless-stopped
    networks:
      - stf-internal
    ports:
      - "${BIND_HOST:-127.0.0.1}:${DIAGNOSTIC_API_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
      weaviate:
        condition: service_healthy
      ollama:
        condition: service_started
    environment:
      # Database
      DB_HOST: ${POSTGRES_HOST:-postgres}
      DB_PORT: ${POSTGRES_PORT:-5432}
      DB_NAME: ${APP_DB_NAME:-stf_diagnosis}
      DB_USER: ${APP_DB_USER:-stf_app_user}
      DB_PASSWORD: ${APP_DB_PASSWORD}

      # LLM Configuration
      LLM_ENDPOINT: ${OLLAMA_BASE_URL:-http://ollama:11434}
      LLM_MODEL: ${OLLAMA_DEFAULT_MODEL:-llama3:8b}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-nomic-embed-text}

      # Weaviate Configuration
      WEAVIATE_URL: http://weaviate:8080
      WEAVIATE_API_KEY: ${WEAVIATE_AUTHENTICATION_APIKEY_ALLOWED_KEYS}

      # Logging
      LOG_LEVEL: ${DIAGNOSTIC_API_LOG_LEVEL:-INFO}
      LOG_FORMAT: ${DIAGNOSTIC_API_LOG_FORMAT:-json}
      LOG_FILE: ${DIAGNOSTIC_API_LOG_FILE:-/app/logs/diagnostic_api.log}

      # Security
      STRICT_MODE: ${DIAGNOSTIC_API_STRICT_MODE:-true}
      REDACT_PII: ${DIAGNOSTIC_API_REDACT_PII:-true}
      ALLOW_EXTERNAL_APIS: ${DIAGNOSTIC_API_ALLOW_EXTERNAL_APIS:-false}
    volumes:
      - diagnostic_api_logs:/app/logs
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
